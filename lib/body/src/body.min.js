"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var scrollProcessTimeout,_xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,l,o){return l in e?Object.defineProperty(e,l,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[l]=o,e}function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.optimizeOpts.delayHover}function renderBorder(e,l){return e("div",{class:"s-table-".concat(l,"ed-borders"),ref:"".concat(l,"Borders")},[e("span",{class:"s-table-border-top",ref:"".concat(l,"Top")}),e("span",{class:"s-table-border-right",ref:"".concat(l,"Right")}),e("span",{class:"s-table-border-bottom",ref:"".concat(l,"Bottom")}),e("span",{class:"s-table-border-left",ref:"".concat(l,"Left")})])}function renderColumn(e,l,o,t,r,n,s,i,c,d,a,u,p){var f,y,x=o._e,m=o.$listeners,g=o.tableData,v=o.height,w=o.columnKey,b=o.overflowX,h=o.scrollXLoad,$=o.scrollYLoad,_=o.highlightCurrentRow,T=o.showOverflow,C=o.align,I=o.cellClassName,S=o.cellStyle,L=o.spanMethod,k=o.radioConfig,q=void 0===k?{}:k,B=o.expandConfig,E=void 0===B?{}:B,R=o.treeConfig,P=void 0===R?{}:R,U=o.mouseConfig,O=void 0===U?{}:U,H=o.editConfig,D=o.editRules,M=o.validOpts,X=o.editStore,Y=o.validStore,A=a.editRender,F=a.align,N=a.showOverflow,z=a.className,j=X.actived,K=n?a.fixed!==n:a.fixed&&b,W=_xeUtils.default.isUndefined(N)||_xeUtils.default.isNull(N)?T:N,G="ellipsis"===W,J="title"===W,Q=!0===W||"complete"===W,V="tooltip"===W,Z=J||Q||V||G,ee={},le=F||C,oe=Y.row===i&&Y.column===a,te=D&&("default"===M.message?v||1<g.length:"inline"===M.message),re={"data-colid":a.id},ne=A&&H&&"dblclick"===H.trigger,se={$table:o,$seq:t,seq:r,row:i,rowIndex:c,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:K,level:s,data:g},ie=o.checkboxConfig||o.selectConfig||{};if(!h&&!$||Z||(G=Z=!0),(J||V||Q||m["cell-mouseenter"])&&(ee.mouseenter=function(e){if(!isOperateMouse(o)){var l={$table:o,seq:r,row:i,rowIndex:c,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,locationType:"body",isHidden:K,level:s,cell:e.currentTarget};J?_tools.DomTools.updateCellTitle(e):Q?o.triggerCompleteEvent(e,l):V&&o.triggerTooltipEvent(e,l),_tools.UtilTools.emitEvent(o,"cell-mouseenter",[l,e])}}),(V||Q||m["cell-mouseleave"])&&(ee.mouseleave=function(e){isOperateMouse(o)||(V&&o.handleTargetLeaveEvent(e),Q&&o.closeComplete(e),_tools.UtilTools.emitEvent(o,"cell-mouseleave",[{$table:o,seq:r,row:i,rowIndex:c,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:K,level:s,cell:e.currentTarget},e]))}),(O.checked||O.selected)&&(ee.mousedown=function(e){o.triggerCellMousedownEvent(e,{$table:o,seq:r,row:i,rowIndex:c,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:K,level:s,cell:e.currentTarget})}),(_||m["cell-click"]||O.checked||A&&H||"row"===E.trigger||"cell"===E.trigger||"row"===q.trigger||"radio"===a.type&&"cell"===q.trigger||"row"===ie.trigger||("checkbox"===a.type||"selection"===a.type)&&"cell"===ie.trigger||"row"===P.trigger||a.treeNode&&"cell"===P.trigger)&&(ee.click=function(e){o.triggerCellClickEvent(e,{$table:o,row:i,rowIndex:c,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:K,level:s,cell:e.currentTarget})}),(ne||m["cell-dblclick"])&&(ee.dblclick=function(e){o.triggerCellDBLClickEvent(e,{$table:o,seq:r,row:i,rowIndex:c,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:K,level:s,cell:e.currentTarget})}),L){var ce=L(se)||{},de=ce.rowspan,ae=void 0===de?1:de,ue=ce.colspan,pe=void 0===ue?1:ue;if(!ae||!pe)return null;re.rowspan=ae,re.colspan=pe}return!K&&H&&H.showStatus&&(y=o.isUpdateByRow(i,a.property)),e("td",{class:["s-body--column",a.id,(f={},_defineProperty(f,"col--".concat(le),le),_defineProperty(f,"col--edit",A),_defineProperty(f,"col--index","index"===a.type),_defineProperty(f,"col--ellipsis",Z),_defineProperty(f,"edit--visible",A&&"visible"===A.type),_defineProperty(f,"fixed--hidden",K),_defineProperty(f,"col--dirty",y),_defineProperty(f,"col--actived",H&&A&&j.row===i&&(j.column===a||"row"===H.mode)),_defineProperty(f,"col--valid-error",oe),f),_tools.UtilTools.getClass(z,se),_tools.UtilTools.getClass(I,se)],key:w?a.id:u,attrs:re,style:S?_xeUtils.default.isFunction(S)?S(se):S:null,on:ee},T&&K?[]:[e("div",{class:["s-cell",{"c--title":J,"c--complete":Q,"c--tooltip":V,"c--ellipsis":G}],attrs:{title:J?_tools.UtilTools.getCellLabel(i,a,se):null}},a.renderCell(e,se)),te?oe?e("div",{class:"s-cell--valid",style:Y.rule&&Y.rule.width?{width:"".concat(Y.rule.width,"px")}:null},[e("span",{class:"s-cell--valid-msg"},Y.content)]):x():null])}function renderRows(u,p,f,y,x,m,e,g){var v=f.stripe,w=f.rowKey,b=f.highlightHoverRow,h=f.rowClassName,$=f.rowStyle,_=f.treeConfig,T=f.treeExpandeds,C=f.scrollYLoad,I=f.scrollYStore,S=f.editStore,L=f.expandeds,k=f.getColumnIndex,q=[];return e.forEach(function(t,r){var e,l={},n=r,s=n+1;C&&(s+=I.startIndex),n=f.getRowIndex(t),b&&(l.mouseenter=function(e){isOperateMouse(f)||f.triggerHoverEvent(e,{row:t,rowIndex:n})},l.mouseleave=function(e){isOperateMouse(f)||f.clearHoverRow()});var o=_tools.UtilTools.getRowid(f,t);if(q.push(u("tr",{class:["s-body--row",(e={"row--stripe":v&&0<n&&(n+1)%2==0},_defineProperty(e,"row--level-".concat(x),_),_defineProperty(e,"row--new",-1<S.insertList.indexOf(t)),e),h?_xeUtils.default.isFunction(h)?h({$table:f,$seq:y,seq:s,fixedType:m,rowLevel:x,row:t,rowIndex:n,$rowIndex:r}):h:""],attrs:{"data-rowid":o},style:$?_xeUtils.default.isFunction($)?$({$table:f,$seq:y,seq:s,fixedType:m,rowLevel:x,row:t,rowIndex:n,$rowIndex:r}):$:null,key:w||_?o:r,on:l},g.map(function(e,l){var o=k(e);return renderColumn(u,p,f,y,s,m,x,t,n,r,e,o,l)}))),L.length&&-1<L.indexOf(t)){var i,c=_xeUtils.default.find(g,function(e){return"expand"===e.type}),d=k(c);_&&(i={paddingLeft:"".concat(x*(_.indent||16)+30,"px")}),c&&q.push(u("tr",{class:"s-body--expanded-row",key:"expand_".concat(o),style:$?_xeUtils.default.isFunction($)?$({$table:f,$seq:y,seq:s,fixedType:m,rowLevel:x,row:t,rowIndex:n,$rowIndex:r,isExpanded:!0}):$:null,on:l},[u("td",{class:"s-body--expanded-column",attrs:{colspan:g.length}},[u("div",{class:["s-body--expanded-cell",{"fixed--hidden":m}],style:i},[c.renderData(u,{$table:f,seq:s,row:t,rowIndex:n,column:c,columnIndex:d,fixed:m,level:x})])])]))}if(_&&T.length){var a=t[_.children];a&&a.length&&-1<T.indexOf(t)&&q.push.apply(q,renderRows(u,p,f,y?"".concat(y,".").concat(s):"".concat(s),x+1,m,a,g))}}),q}function syncBodyScroll(e,l,o){(l||o)&&(l&&(l.onscroll=null,l.scrollTop=e),o&&(o.onscroll=null,o.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){l&&(l.onscroll=l._onscroll),o&&(o.onscroll=o._onscroll)},100))}var _default={name:"STableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,collectColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,l=this.$el,o=this.$refs,t=this.fixedType,r=e.elemStore,n="".concat(t||"main","-body-");r["".concat(n,"wrapper")]=l,r["".concat(n,"table")]=o.table,r["".concat(n,"colgroup")]=o.colgroup,r["".concat(n,"list")]=o.tbody,r["".concat(n,"xSpace")]=o.xSpace,r["".concat(n,"ySpace")]=o.ySpace,r["".concat(n,"emptyBlock")]=o.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(o){var e=this._e,l=this.$parent,t=this.fixedColumn,r=this.fixedType,n=l.$scopedSlots,s=l.tableData,i=l.tableColumn,c=l.showOverflow,d=l.scrollXLoad,a=l.mouseConfig,u=void 0===a?{}:a,p=l.keyboardConfig,f=void 0===p?{}:p;return r&&c?i=t:d&&r&&(i=t),o("div",{class:["s-table--body-wrapper",r?"fixed-".concat(r,"--wrapper"):"body--wrapper"]},[r?e():o("div",{class:"s-body--x-space",ref:"xSpace"}),o("div",{class:"s-body--y-space",ref:"ySpace"}),o("table",{class:"s-table--body",attrs:{cellspacing:0,cellpadding:0,border:0},ref:"table"},[o("colgroup",{ref:"colgroup"},i.map(function(e,l){return o("col",{attrs:{name:e.id},key:l})})),o("tbody",{ref:"tbody"},renderRows(o,this,l,"",0,r,s,i))]),r||!u.checked&&!f.isCut?null:o("div",{class:"s-table--borders"},[u.checked?renderBorder(o,"check"):null,f.isCut?renderBorder(o,"copy"):null]),r?null:o("div",{class:"s-table--empty-block".concat(s.length?"":" is--visible"),ref:"emptyBlock"},[o("span",{class:"s-table--empty-text"},n.empty?n.empty.call(this,{$table:l},o):_conf.default.i18n("s.table.emptyText"))])])},methods:{scrollEvent:function(e){var l=this.$parent,o=this.fixedType,t=l.$refs,r=l.highlightHoverRow,n=l.scrollXLoad,s=l.scrollYLoad,i=l.lastScrollTop,c=l.lastScrollLeft,d=t.tableHeader,a=t.tableBody,u=t.leftBody,p=t.rightBody,f=t.tableFooter,y=d?d.$el:null,x=f?f.$el:null,m=a.$el,g=u?u.$el:null,v=p?p.$el:null,w=m.scrollTop,b=m.scrollLeft,h=b!==c,$=w!==i;l.$refs["s-table-complete"]&&(l.$refs["s-table-complete"].style.display="none"),l.lastScrollTop=w,l.lastScrollLeft=b,l.lastScrollTime=Date.now(),r&&l.clearHoverRow(),g&&"left"===o?syncBodyScroll(w=g.scrollTop,m,v):v&&"right"===o?syncBodyScroll(w=v.scrollTop,m,g):(h&&(y&&(y.scrollLeft=m.scrollLeft),x&&(x.scrollLeft=m.scrollLeft)),(g||v)&&(l.checkScrolling(),$&&syncBodyScroll(w,g,v))),n&&h&&(l.triggerScrollXEvent(e),y&&b+m.clientWidth>=m.scrollWidth-80&&this.$nextTick(function(){m.scrollLeft!==y.scrollLeft&&(y.scrollLeft=m.scrollLeft)})),s&&$&&l.triggerScrollYEvent(e),_tools.UtilTools.emitEvent(l,"scroll",[{type:"body",fixed:o,scrollTop:w,scrollLeft:b,isX:h,isY:$,$table:l},e])}}};exports.default=_default;