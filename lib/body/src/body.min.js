"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var scrollProcessTimeout,_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,l,o){return l in e?Object.defineProperty(e,l,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[l]=o,e}function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+100}function renderBorder(e,l){return e("div",{class:"s-table-".concat(l,"ed-borders"),ref:"".concat(l,"Borders")},[e("span",{class:"s-table-border-top",ref:"".concat(l,"Top")}),e("span",{class:"s-table-border-right",ref:"".concat(l,"Right")}),e("span",{class:"s-table-border-bottom",ref:"".concat(l,"Bottom")}),e("span",{class:"s-table-border-left",ref:"".concat(l,"Left")})])}function renderColumn(e,l,o,t,r,n,s,c,i,d,a,u,p){var f,m,y=o._e,g=o.$listeners,x=o.tableData,v=o.height,b=o.columnKey,w=o.overflowX,h=o.scrollXLoad,_=o.scrollYLoad,$=o.highlightCurrentRow,T=o.showOverflow,C=o.align,I=o.cellClassName,S=o.spanMethod,k=o.radioConfig,L=void 0===k?{}:k,B=o.selectConfig,P=void 0===B?{}:B,E=o.treeConfig,R=void 0===E?{}:E,q=o.mouseConfig,O=void 0===q?{}:q,D=o.editConfig,U=o.editRules,H=o.validOpts,M=o.editStore,X=o.validStore,Y=a.editRender,A=a.align,N=a.showOverflow,j=M.actived,z=n?a.fixed!==n:a.fixed&&w,F=_xeUtils.default.isUndefined(N)||_xeUtils.default.isNull(N)?T:N,K="ellipsis"===F,W="title"===F,G=!0===F||"complete"===F,J="tooltip"===F,Q=W||G||J||K,V={},Z=A||C,ee=X.row===c&&X.column===a,le=U&&("default"===H.message?v||1<x.length:"inline"===H.message),oe={"data-colid":a.id},te=Y&&D&&"dblclick"===D.trigger,re={$table:o,$seq:t,seq:r,row:c,rowIndex:i,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:z,level:s,data:x};if(!h&&!_||Q||(K=!0),(W||J||G||g["cell-mouseenter"])&&(V.mouseenter=function(e){if(!isOperateMouse(o)){var l={$table:o,seq:r,row:c,rowIndex:i,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,locationType:"body",isHidden:z,level:s,cell:e.currentTarget};W?_tools.DomTools.updateCellTitle(e):G?o.triggerCompleteEvent(e,l):J&&o.triggerTooltipEvent(e,l),_tools.UtilTools.emitEvent(o,"cell-mouseenter",[l,e])}}),(J||G||g["cell-mouseleave"])&&(V.mouseleave=function(e){isOperateMouse(o)||(J&&o.clostTooltip(),G&&o.closeComplete(e),_tools.UtilTools.emitEvent(o,"cell-mouseleave",[{$table:o,seq:r,row:c,rowIndex:i,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:z,level:s,cell:e.currentTarget},e]))}),(O.checked||O.selected)&&(V.mousedown=function(e){o.triggerCellMousedownEvent(e,{$table:o,seq:r,row:c,rowIndex:i,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:z,level:s,cell:e.currentTarget})}),($||g["cell-click"]||O.checked||Y&&D||"row"===L.trigger||"radio"===a.type&&"cell"===L.trigger||"row"===P.trigger||"selection"===a.type&&"cell"===P.trigger||"row"===R.trigger||a.treeNode&&"cell"===R.trigger)&&(V.click=function(e){o.triggerCellClickEvent(e,{$table:o,row:c,rowIndex:i,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:z,level:s,cell:e.currentTarget})}),(te||g["cell-dblclick"])&&(V.dblclick=function(e){o.triggerCellDBLClickEvent(e,{$table:o,seq:r,row:c,rowIndex:i,$rowIndex:d,column:a,columnIndex:u,$columnIndex:p,fixed:n,isHidden:z,level:s,cell:e.currentTarget})}),S){var ne=S(re)||{},se=ne.rowspan,ce=void 0===se?1:se,ie=ne.colspan,de=void 0===ie?1:ie;if(!ce||!de)return null;oe.rowspan=ce,oe.colspan=de}return!z&&D&&D.showStatus&&(m=o.hasRowChange(c,a.property)),e("td",{class:["s-body--column",a.id,(f={},_defineProperty(f,"col--".concat(Z),Z),_defineProperty(f,"col--edit",Y),_defineProperty(f,"col--index","index"===a.type),_defineProperty(f,"col--ellipsis",Q),_defineProperty(f,"edit--visible",Y&&"visible"===Y.type),_defineProperty(f,"fixed--hidden",z),_defineProperty(f,"col--dirty",m),_defineProperty(f,"col--actived",D&&Y&&j.row===c&&(j.column===a||"row"===D.mode)),_defineProperty(f,"col--valid-error",ee),f),I?_xeUtils.default.isFunction(I)?I(re):I:""],key:b?a.id:u,attrs:oe,on:V},T&&z?[]:[e("div",{class:["s-cell",{"c--title":W,"c--complete":G,"c--tooltip":J,"c--ellipsis":K}],attrs:{title:W?_tools.UtilTools.getCellLabel(c,a,re):null}},a.renderCell(e,re)),le?ee?e("div",{class:"s-cell--valid",style:X.rule&&X.rule.width?{width:"".concat(X.rule.width,"px")}:null},[e("span",{class:"s-cell--valid-msg"},X.content)]):y():null])}function renderRows(u,p,f,m,y,g,e,x){var v=f.rowKey,b=f.highlightHoverRow,w=f.rowClassName,h=f.treeConfig,_=f.treeExpandeds,$=f.scrollYLoad,T=f.scrollYStore,C=f.editStore,I=f.expandeds,S=f.getColumnIndex,k=[];return e.forEach(function(t,r){var e,l={},n=r,s=n+1;$&&(s+=T.startIndex),n=f.getRowIndex(t),b&&(l.mouseenter=function(e){isOperateMouse(f)||f.triggerHoverEvent(e,{row:t,rowIndex:n})});var o=_tools.UtilTools.getRowid(f,t);if(k.push(u("tr",{class:["s-body--row",(e={},_defineProperty(e,"row--level-".concat(y),h),_defineProperty(e,"row--new",-1<C.insertList.indexOf(t)),e),w?_xeUtils.default.isFunction(w)?w({$table:f,seq:s,row:t,rowIndex:n}):w:""],attrs:{"data-rowid":o},key:v||h?o:r,on:l},x.map(function(e,l){var o=S(e);return renderColumn(u,p,f,m,s,g,y,t,n,r,e,o,l)}))),I.length&&-1<I.indexOf(t)){var c,i=x.find(function(e){return"expand"===e.type}),d=S(i);h&&(c={paddingLeft:"".concat(y*(h.indent||16)+30,"px")}),i&&k.push(u("tr",{class:"s-body--expanded-row",key:"expand_".concat(o),on:l},[u("td",{class:"s-body--expanded-column",attrs:{colspan:x.length}},[u("div",{class:"s-body--expanded-cell",style:c},[i.renderData(u,{$table:f,seq:s,row:t,rowIndex:n,column:i,columnIndex:d,fixed:g,level:y})])])]))}if(h&&_.length){var a=t[h.children];a&&a.length&&-1<_.indexOf(t)&&k.push.apply(k,renderRows(u,p,f,m?"".concat(m,".").concat(s):"".concat(s),y+1,g,a,x))}}),k}function syncBodyScroll(e,l,o){(l||o)&&(l&&(l.onscroll=null,l.scrollTop=e),o&&(o.onscroll=null,o.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){l&&(l.onscroll=l._onscroll),o&&(o.onscroll=o._onscroll)},100))}var _default={name:"STableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,collectColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,l=this.$el,o=this.$refs,t=this.fixedType,r=e.elemStore,n="".concat(t||"main","-body-");r["".concat(n,"wrapper")]=l,r["".concat(n,"table")]=o.table,r["".concat(n,"colgroup")]=o.colgroup,r["".concat(n,"list")]=o.tbody,r["".concat(n,"xSpace")]=o.xSpace,r["".concat(n,"ySpace")]=o.ySpace,r["".concat(n,"emptyBlock")]=o.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(o){var e=this._e,l=this.$parent,t=this.fixedColumn,r=this.fixedType,n=l.tableData,s=l.tableColumn,c=l.showOverflow,i=l.scrollXLoad,d=l.mouseConfig,a=void 0===d?{}:d,u=l.keyboardConfig,p=void 0===u?{}:u;return r&&c?s=t:i&&r&&(s=t),o("div",{class:["s-table--body-wrapper",r?"fixed-".concat(r,"--wrapper"):"body--wrapper"],on:{mouseleave:l.clearHoverRow}},[r?e():o("div",{class:"s-body--x-space",ref:"xSpace"}),o("div",{class:"s-body--y-space",ref:"ySpace"}),o("table",{class:"s-table--body",attrs:{cellspacing:0,cellpadding:0,border:0},ref:"table"},[o("colgroup",{ref:"colgroup"},s.map(function(e,l){return o("col",{attrs:{name:e.id},key:l})})),o("tbody",{ref:"tbody"},renderRows(o,this,l,"",0,r,n,s))]),r||!a.checked&&!p.isCut?null:o("div",{class:"s-table--borders"},[a.checked?renderBorder(o,"check"):null,p.isCut?renderBorder(o,"copy"):null]),r?null:o("div",{class:"s-table--empty-block".concat(n.length?"":" is--visible"),ref:"emptyBlock"},[o("span",{class:"s-table--empty-text"},l.$slots.empty||_conf.default.i18n("soul.table.emptyText"))])])},methods:{scrollEvent:function(e){var l=this.$parent,o=this.fixedType,t=l.$refs,r=l.scrollXLoad,n=l.scrollYLoad,s=l.lastScrollTop,c=l.lastScrollLeft,i=t.tableHeader,d=t.tableBody,a=t.leftBody,u=t.rightBody,p=i?i.$el:null,f=d.$el,m=a?a.$el:null,y=u?u.$el:null,g=f.scrollTop,x=f.scrollLeft,v=x!==c,b=g!==s;l.$refs["s-table-complete"]&&(l.$refs["s-table-complete"].style.display="none"),l.lastScrollTop=g,l.lastScrollLeft=x,l.lastScrollTime=Date.now(),m&&"left"===o?syncBodyScroll(g=m.scrollTop,f,y):y&&"right"===o?syncBodyScroll(g=y.scrollTop,f,m):(v&&p&&(p.scrollLeft=f.scrollLeft),(m||y)&&(l.checkScrolling(),b&&syncBodyScroll(g,m,y))),r&&v&&(l.triggerScrollXEvent(e),p&&x+f.clientWidth>=f.scrollWidth&&this.$nextTick(function(){f.scrollLeft!==p.scrollLeft&&(p.scrollLeft=f.scrollLeft)})),n&&b&&l.triggerScrollYEvent(e),_tools.UtilTools.emitEvent(l,"scroll",[{type:"body",fixed:o,scrollTop:g,scrollLeft:x,isX:v,isY:b,$table:l},e])}}};exports.default=_default;