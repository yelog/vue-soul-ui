"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tableCore=_interopRequireWildcard(require("../../table-core")),_tools=require("../../tools");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var t=new WeakMap;return _getRequireWildcardCache=function(){return t},t}function _interopRequireWildcard(t){if(t&&t.__esModule)return t;if(null===t||"object"!==_typeof(t)&&"function"!=typeof t)return{default:t};var e=_getRequireWildcardCache();if(e&&e.has(t))return e.get(t);var o={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=i?Object.getOwnPropertyDescriptor(t,n):null;r&&(r.get||r.set)?Object.defineProperty(o,n,r):o[n]=t[n]}return o.default=t,e&&e.set(t,o),o}function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var _default2={name:"SToolbar",props:{id:String,loading:!1,resizable:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.resizable}},refresh:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.refresh}},import:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.import}},export:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.export}},setting:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.setting}},buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String,data:Array,customs:Array},inject:{$grid:{default:null}},data:function(){return{$table:null,isRefresh:!1,tableFullColumn:[],importStore:{file:null,type:"",filename:"",visible:!1},importParams:{mode:"",types:null,message:!0},exportStore:{name:"",mode:"",columns:[],selectRecords:[],hasFooter:!1,forceOriginal:!1,visible:!1},exportParams:{filename:"",sheetName:"",type:"",types:[],original:!1,message:!0,isHeader:!1,isFooter:!1},settingStore:{visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},importOpts:function(){return Object.assign({},_conf.default.toolbar.import,this.import)},exportOpts:function(){return Object.assign({},_conf.default.toolbar.export,this.export)},resizableOpts:function(){return Object.assign({storageKey:"S_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},settingOpts:function(){return Object.assign({storageKey:"S_TABLE_CUSTOM_COLUMN_HIDDEN"},_conf.default.toolbar.setting,this.setting)}},created:function(){var t=this,e=this.settingOpts,o=this.id,i=this.customs;if(i&&(this.tableFullColumn=i),e.storage&&!o)return _tools.UtilTools.error("s.error.toolbarId");_tableCore.default._export||!this.export&&!this.import||_tools.UtilTools.error("s.error.reqModule",["Export"]),this.$nextTick(function(){t.updateConf(),t.loadStorage()}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(r){var t,s=this,o=this._e,e=this.$scopedSlots,i=this.$grid,n=this.$table,l=this.loading,a=this.settingStore,u=this.refresh,c=this.setting,f=this.settingOpts,p=this.buttons,h=void 0===p?[]:p,d=this.vSize,b=this.tableFullColumn,g=this.importStore,m=this.importParams,v=this.exportStore,_=this.exportParams,y={},S={},x=e.buttons,O=e.tools;return c&&("manual"===f.trigger||("hover"===f.trigger?(y.mouseenter=this.handleMouseenterSettingEvent,y.mouseleave=this.handleMouseleaveSettingEvent,S.mouseenter=this.handleWrapperMouseenterEvent,S.mouseleave=this.handleWrapperMouseleaveEvent):y.click=this.handleClickSettingEvent)),r("div",{class:["s-toolbar",(t={},_defineProperty(t,"size--".concat(d),d),_defineProperty(t,"is--loading",l),t)]},[r("div",{class:"s-button--wrapper"},x?x.call(this,{$grid:i,$table:n},r):h.map(function(e){return!1===e.visible?o():r("s-button",{on:{click:function(t){return s.btnEvent(t,e)}},props:{disabled:e.disabled},scopedSlots:e.dropdowns&&e.dropdowns.length?{default:function(){return _tools.UtilTools.getFuncText(e.name)},dropdowns:function(){return e.dropdowns.map(function(e){return!1===e.visible?o():r("s-button",{on:{click:function(t){return s.btnEvent(t,e)}},props:{disabled:e.disabled}},_tools.UtilTools.getFuncText(e.name))})}}:null},_tools.UtilTools.getFuncText(e.name))})),r("div",{class:"s-tools--operate"},[this.import?r("s-button",{class:"s-export--btn",props:{type:"text",icon:_conf.default.icon.import},on:{click:this.importEvent}}):null,this.export?r("s-button",{class:"s-export--btn",props:{type:"text",icon:_conf.default.icon.export},on:{click:this.exportEvent}}):null,u?r("s-button",{class:"s-refresh--btn",props:{type:"text",icon:_conf.default.icon.refresh,loading:this.isRefresh},on:{click:this.refreshEvent}}):null,c?r("div",{class:["s-custom--wrapper",{"is--active":a.visible}],ref:"customWrapper"},[r("div",{class:"s-custom--setting-btn",on:y},[r("i",{class:_conf.default.icon.custom})]),r("div",{class:"s-custom--option-wrapper"},[r("div",{class:"s-custom--option",on:S},b.map(function(e){var t=e.property,o=e.visible,i=e.own,n=_tools.UtilTools.getFuncText(i.title||i.label);return t&&n?r("s-checkbox",{props:{value:o,disabled:!!f.checkMethod&&!f.checkMethod({column:e})},attrs:{title:n},on:{change:function(t){e.visible=t,c&&f.immediate&&s.updateSetting()}}},n):null}))])]):null]),_tableCore.default._export?r("s-import-panel",{props:{defaultOptions:m,storeData:g},on:{import:this.confirmImportEvent}}):o(),_tableCore.default._export?r("s-export-panel",{props:{defaultOptions:_,storeData:v},on:{print:this.confirmPrintEvent,export:this.confirmExportEvent}}):o(),O?r("div",{class:"s-tools--wrapper"},O.call(this,{$grid:i,$table:n},r)):null])},methods:{updateConf:function(){var t=this.$parent,o=this.data,e=t.$children,i=e.indexOf(this);this.$table=_xeUtils.default.find(e,function(t,e){return t&&t.refreshColumn&&i<e&&(o?t.data===o:"s-table"===t.$vnode.componentOptions.tag)})},openSetting:function(){this.settingStore.visible=!0},closeSetting:function(){var t=this.setting,e=this.settingStore;e.visible&&(e.visible=!1,t&&!e.immediate&&this.updateSetting())},loadStorage:function(){var t=this.$grid,e=this.$table,o=this.id,i=this.refresh,n=this.resizable,r=this.setting,s=this.refreshOpts,l=this.resizableOpts,a=this.settingOpts;if(i&&!t&&(s.query||_tools.UtilTools.warn("s.error.notFunc",["query"])),t||e)(t||e).connect({toolbar:this});else if(n||r)throw new Error(_tools.UtilTools.getLog("s.error.barUnableLink"));if(n||r){var u={};if(l.storage){var c=this.getStorageMap(l.storageKey)[o];c&&_xeUtils.default.each(c,function(t,e){u[e]={field:e,resizeWidth:t}})}if(a.storage){var f=this.getStorageMap(a.storageKey)[o];f&&f.split(",").forEach(function(t){u[t]?u[t].visible=!1:u[t]={field:t,visible:!1}})}var p=Object.values(u);this.updateCustoms(p.length?p:this.tableFullColumn)}},updateColumn:function(t){this.tableFullColumn=t},updateCustoms:function(t){var e=this,o=this.$grid,i=this.$table,n=o||i;n&&n.reloadCustoms(t).then(function(t){e.tableFullColumn=t})},getStorageMap:function(t){var e=_conf.default.version,o=_xeUtils.default.toStringJSON(localStorage.getItem(t));return o&&o._v===e?o:{_v:e}},saveColumnHide:function(){var t=this.id,e=this.tableFullColumn,o=this.settingOpts;if(o.storage){var i=this.getStorageMap(o.storageKey),n=e.filter(function(t){return t.property&&!t.visible});i[t]=n.length?n.map(function(t){return t.property}).join(","):void 0,localStorage.setItem(o.storageKey,_xeUtils.default.toJSONString(i))}return this.$nextTick()},saveColumnWidth:function(t){var e=this.id,o=this.tableFullColumn,i=this.resizableOpts;if(i.storage){var n,r=this.getStorageMap(i.storageKey);t||(n=_xeUtils.default.isPlainObject(r[e])?r[e]:{},o.forEach(function(t){var e=t.property,o=t.resizeWidth,i=t.renderWidth;e&&o&&(n[e]=i)})),r[e]=_xeUtils.default.isEmpty(n)?void 0:n,localStorage.setItem(i.storageKey,_xeUtils.default.toJSONString(r))}return this.$nextTick()},hideColumn:function(t){return _tools.UtilTools.warn("s.error.delFunc",["hideColumn","table.hideColumn"]),t.visible=!1,this.updateSetting()},showColumn:function(t){return _tools.UtilTools.warn("s.error.delFunc",["showColumn","table.showColumn"]),t.visible=!0,this.updateSetting()},resetCustoms:function(){return this.updateSetting()},resetResizable:function(){this.updateResizable(this)},updateResizable:function(t){var e=this.$grid,o=this.$table,i=e||o;return this.saveColumnWidth(t),i.analyColumnWidth(),i.recalculate(!0)},updateSetting:function(){return(this.$grid||this.$table).refreshColumn(),this.saveColumnHide()},handleGlobalMousedownEvent:function(t){_tools.DomTools.getEventTargetNode(t,this.$refs.customWrapper).flag||this.closeSetting()},handleGlobalBlurEvent:function(){this.closeSetting()},handleClickSettingEvent:function(){var t=this.settingStore;t.visible=!t.visible},handleMouseenterSettingEvent:function(){this.settingStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(){var t=this,e=this.settingStore;e.activeBtn=!1,setTimeout(function(){e.activeBtn||e.activeWrapper||t.closeSetting()},300)},handleWrapperMouseenterEvent:function(){this.settingStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(){var t=this,e=this.settingStore;e.activeWrapper=!1,setTimeout(function(){e.activeBtn||e.activeWrapper||t.closeSetting()},300)},refreshEvent:function(){var t=this,e=this.$grid,o=this.refreshOpts;this.isRefresh||(o.query?(this.isRefresh=!0,o.query().catch(function(t){return t}).then(function(){t.isRefresh=!1})):e&&(this.isRefresh=!0,e.commitProxy("reload").catch(function(t){return t}).then(function(){t.isRefresh=!1})))},btnEvent:function(t,e){var o=this.$grid,i=this.$table,n=e.code;if(n)if(o)o.triggerToolbarBtnEvent(e,t);else{var r=_tableCore.Buttons.get(n),s={code:n,button:e,$grid:o,$table:i};r&&r.call(this,s,t),_tools.UtilTools.emitEvent(this,"button-click",[s,t])}},importEvent:function(){this.openImport()},openImport:function(t){var e=this.importParams,o=this.importStore,i=this.importOpts,n=Object.assign({mode:"covering",message:!0},t,i);Object.assign(o,{file:null,type:"",filename:"",visible:!0}),Object.assign(e,n)},confirmImportEvent:function(t){var e=this.$grid,o=this.$table;(e||o).importByFile(this.importStore.file,t)},exportEvent:function(){this.openExport()},openExport:function(t){var e=this.$grid,o=this.$table,i=this.exportOpts,n=this.exportStore,r=this.exportParams,s=e||o,l=s.getTableColumn().fullColumn,a=s.getTableData().footerData,u=s.getSelectRecords(),c=s.getVirtualScroller(),f=l.filter(function(t){return"index"===t.type||t.property&&-1===["checkbox","selection","radio"].indexOf(t.type)}),p=s.getTreeStatus(),h=!!p||c.scrollX||c.scrollY,d=!!a.length,b=Object.assign({original:!0,message:!0},i,t),g=b.types||_tableCore.default.exportTypes;return b.types=g.map(function(t){return{value:t,label:"s.types.".concat(t)}}),f.forEach(function(t){t.checked="index"!==t.type}),Object.assign(n,{columns:f,selectRecords:u,mode:u.length?"selected":"all",forceOriginal:!!p||c.scrollX||c.scrollY,hasFooter:!!a.length,visible:!0}),Object.assign(r,{filename:b.filename||"",sheetName:b.sheetName||"",type:b.type||b.types[0].value,types:b.types,original:h||b.original,message:b.message,isHeader:!0,isFooter:d}),this.$nextTick()},confirmPrintEvent:function(t){(this.$grid||this.$table).print(t)},confirmExportEvent:function(t){(this.$grid||this.$table).exportData(t)}}};exports.default=_default2;